from office365.sharepoint.client_context import ClientContext
from office365.runtime.auth.client_credential import ClientCredential
import base64
import os
import json

# ---------- CONFIGURE YOUR SHAREPOINT SETTINGS ----------
SITE_URL = ""
CLIENT_ID = "<your-client-id>"
CLIENT_SECRET = "<your-client-secret>"
START_FOLDER = "Shared Documents/General/test_bank/Q1 2025"

# --------------------------------------------------------

credentials = ClientCredential(CLIENT_ID, CLIENT_SECRET)
ctx = ClientContext(SITE_URL).with_credentials(credentials)


def get_file_metadata(file):
    file_name = file.properties["Name"]
    file_url = file.properties["ServerRelativeUrl"]

    # Download file content
    file_content = file.read().execute_query().content
    base64_str = base64.b64encode(file_content).decode("utf-8")

    return {
        "original_filename": file_name,
        "base64": base64_str,
        "sharepoint_info": {
            "sharepoint_path": file_url
        }
    }


def traverse_folder(folder):
    result = []
    subfolders = folder.folders
    ctx.load(subfolders)
    ctx.execute_query()

    files = folder.files
    ctx.load(files)
    ctx.execute_query()

    # Get files
    for file in files:
        file_info = get_file_metadata(file)
        result.append(file_info)

    # Recurse into subfolders
    for subfolder in subfolders:
        folder_name = subfolder.properties["Name"]
        child_data = traverse_folder(subfolder)
        result.append({folder_name: child_data})

    return result


def extract_metadata_from_path(path: str):
    parts = path.replace("Shared Documents/", "").split("/")
    if len(parts) >= 2:
        quarter_year = parts[-1]
        industry = parts[-2]
        return quarter_year, industry
    return None, None


# Starting from the provided folder
relative_url = f"/sites/AppleBankAndCitiPOC/{START_FOLDER}"
start_folder = ctx.web.get_folder_by_server_relative_url(relative_url)
ctx.load(start_folder)
ctx.execute_query()

print("Traversing SharePoint folder...")
files_data = traverse_folder(start_folder)

# Tag with metadata
quarter_year, industry = extract_metadata_from_path(START_FOLDER)
json_output = {
    "quarter_year": quarter_year,
    "industry": industry,
    "files": files_data
}

# Print the final structured JSON
print(json.dumps(json_output, indent=2)[:1000])  # Limit output if large

# Optionally save to file
with open("sharepoint_output.json", "w") as f:
    json.dump(json_output, f, indent=2)

print("âœ… SharePoint traversal complete.")
