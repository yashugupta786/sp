from office365.sharepoint.client_context import ClientContext
from office365.runtime.auth.client_credential import ClientCredential
import base64
import os

# SharePoint connection config
SITE_URL = 
CLIENT_ID = 
CLIENT_SECRET = 
ROOT_FOLDER =

credentials = ClientCredential(CLIENT_ID, CLIENT_SECRET)
ctx = ClientContext(SITE_URL).with_credentials(credentials)


def get_file_metadata(file):
    try:
        file_name = file.properties['Name']
        file_path = file.properties['ServerRelativeUrl']
        file_content = file.read().execute_query().content
        encoded = base64.b64encode(file_content).decode('utf-8')
        return {
            "doc_id": os.path.splitext(file_name)[0].replace(" ", "_"),
            "original_filename": file_name,
            "base64": encoded,
            "file_hash": "hash_placeholder",
            "status": {
                "text_extraction": "PENDING",
                "vector_indexing": "PENDING"
            },
            "renamed_filename": None,
            "blob_path": None,
            "sas_url": None,
            "sharepoint_info": {
                "path": file_path
            },
            "steps": []
        }
    except Exception as e:
        print(f"[ERROR] Failed to read file {file.properties['Name']}: {e}")
        return None


def traverse_folder(folder, year, quarter, industry=None, obligor=None):
    result = []
    folder.expand(["Folders", "Files"]).get().execute_query()

    # Traverse subfolders
    for subfolder in folder.folders:
        subfolder_name = subfolder.properties['Name']

        if not industry:
            result.extend(traverse_folder(subfolder, year, quarter, industry=subfolder_name))
        elif not obligor:
            result.extend(traverse_folder(subfolder, year, quarter, industry=industry, obligor=subfolder_name))
        else:
            result.extend(traverse_folder(subfolder, year, quarter, industry=industry, obligor=obligor))

    # Handle files
    for file in folder.files:
        doc = get_file_metadata(file)
        if doc:
            doc_run_id = f"{industry}_{quarter}_{year}_{obligor}"
            result.append({
                "year": year,
                "quarter": quarter,
                "industries": [
                    {
                        "industry": industry,
                        "obligors": [
                            {
                                "obligor_name": obligor,
                                "doc_run_id": doc_run_id,
                                "documents": [doc]
                            }
                        ]
                    }
                ]
            })

    return result


# Main Execution
if __name__ == "__main__":
    print(f"\nüìÅ Traversing SharePoint folder: {ROOT_FOLDER.split('/')[-1]}")

    year = 2025
    quarter = "Q1"

    folder = ctx.web.get_folder_by_server_relative_url(ROOT_FOLDER)
    metadata = traverse_folder(folder, year=year, quarter=quarter)

    print("\nüìù Final Metadata Output:")
    for entry in metadata:
        print(entry)
